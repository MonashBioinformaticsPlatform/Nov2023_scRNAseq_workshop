[["index.html", "scRNAseq Analysis in R with Seurat 1 About", " scRNAseq Analysis in R with Seurat 2022-06-30 1 About Material for scRNAseq analysis in R with Seurat workshop. "],["hello-bookdown.html", "2 Hello bookdown 2.1 A section", " 2 Hello bookdown All chapters start with a first-level heading followed by your chapter title, like the line above. There should be only one first-level heading (#) per .Rmd file. 2.1 A section All chapter sections start with a second-level (##) or higher heading followed by your section title, like the sections above and below here. You can have as many as you want within a chapter. An unnumbered section Chapters and sections are numbered by default. To un-number a heading, add a {.unnumbered} or the shorter {-} at the end of the heading, like in this section. "],["schedule.html", "3 Schedule 3.1 Day 1 3.2 Day 2", " 3 Schedule Timetable goes here. 3.1 Day 1 Stuff 3.2 Day 2 More "],["overview.html", "4 Overview 4.1 Day 1 4.2 Day 2", " 4 Overview Timetable goes here. 4.1 Day 1 Stuff 4.2 Day 2 More "],["seuratobject.html", "5 Using a seurat object", " 5 Using a seurat object Load an existing object Plot some clusters on a umap. Plot some gene expression on a umap plot some gene expression by cluster. Look at a table of cell metadata. Look at counts data / expression data Does gene exist? "],["load.html", "6 Load data", " 6 Load data Look at the counts files. Load them. Look at the cell metadata (there’s basically none) "],["qc.html", "7 QC FIltering", " 7 QC FIltering Discuss counts per cell/gene and make plots Discuss that there’s no one threshold everyone pick a threshold and go filter check numbers of cells. save your object (other qc metrics = Mt gene content, cell cycle asignment, low seq diversity e.t.c) "],["reducedims.html", "8 PCAs and UMAPs", " 8 PCAs and UMAPs why pca how to pick genes for pca why not pca? the blob of not very usefulness. Elbow plots oooh umap. "],["clustering.html", "9 Clustering", " 9 Clustering Do clustering Choose a resolution What are the clusters? Find cluster markers Name some. "],["de.html", "10 DE", " 10 DE Discussion of pseudobulk, contrasted with wilxcox test Would run as demo. Needs a new and different dataset with replicates, and alog of mucking about. ################################################################################ # Pseudobulk demo library(SeuratData) library(Seurat) library(tidyverse) library(patchwork) ################################################################################ # Prepare a datasets library(SeuratData) data(&quot;hcabm40k&quot;) #maybe? # grab 4000 random cells keep_cells &lt;- sample(1:ncol(hcabm40k), size=4000) # Subsample down to a toy sized dataset hcabm40k.mini &lt;- hcabm40k[1:2000,keep_cells] # clear large object from memory rm(hcabm40k) # Add a group of contidion vs control to test. Not real # This is the first 4 of 8 bio replicates condition_lookup &lt;- c(&#39;MantonBM1&#39;=&quot;fake_treat&quot;, &#39;MantonBM2&#39;=&quot;fake_treat&quot;, &#39;MantonBM3&#39;=&quot;fake_treat&quot;, &#39;MantonBM4&#39;=&quot;fake_treat&quot;, &#39;MantonBM5&#39;=&quot;fake_control&quot;, &#39;MantonBM6&#39;=&quot;fake_control&quot;, &#39;MantonBM7&#39;=&quot;fake_control&quot;, &#39;MantonBM8&#39;=&quot;fake_control&quot;) hcabm40k.mini$condition &lt;- condition_lookup[hcabm40k.mini@meta.data$orig.ident] table( hcabm40k.mini@meta.data$orig.ident, hcabm40k.mini$condition) # When Diing DE, it makes sense to remove genes with too-low counts to find anything in. # There&#39;s alot of these in single cell. total_per_gene &lt;- rowSums(GetAssayData(hcabm40k.mini, &#39;counts&#39;)) hist(log10(total_per_gene)) hcabm40k.mini &lt;- hcabm40k.mini[total_per_gene &gt;= 100, ] # ADDING SOME FAKE VARIATION! # This only works because this data is ordered by the samples! # multipling first 5 genes of the the &#39;fake treat&#39; group by 4 - so we expect these to be DE. # when in reality, these are simply healthy replicates and shouldn&#39;t be significantly different alter_cells &lt;- which(condition_lookup[hcabm40k.mini$orig.ident] == &quot;fake_treat&quot;) hcabm40k.mini@assays$RNA@counts[1:20, alter_cells ] &lt;- hcabm40k.mini@assays$RNA@counts[1:20, alter_cells ]* 2 alter_genes &lt;- rownames(hcabm40k.mini@assays$RNA@counts)[1:20] #------------------------------------------------------------------------------- # Run thorough a basic processing, with no QC hcabm40k.mini &lt;- NormalizeData(hcabm40k.mini, normalization.method = &quot;LogNormalize&quot;, scale.factor = 10000) hcabm40k.mini &lt;- FindVariableFeatures(hcabm40k.mini, selection.method = &quot;vst&quot;, nfeatures = 2000) all.genes &lt;- rownames(hcabm40k.mini) hcabm40k.mini &lt;- ScaleData(hcabm40k.mini, features = all.genes) hcabm40k.mini &lt;- RunPCA(hcabm40k.mini, features = VariableFeatures(object = hcabm40k.mini)) hcabm40k.mini &lt;- RunUMAP(hcabm40k.mini, dims = 1:10) hcabm40k.mini &lt;- FindNeighbors(hcabm40k.mini, dims = 1:10) hcabm40k.mini &lt;- FindClusters(hcabm40k.mini, resolution = 0.1) # Low res #------------------------------------------------------------------------------- # The object; p1 &lt;- DimPlot(hcabm40k.mini, reduction = &#39;umap&#39;, group.by = &#39;seurat_clusters&#39;) p2 &lt;- DimPlot(hcabm40k.mini, reduction = &#39;umap&#39;, group.by = &#39;orig.ident&#39;) p1+p2 ################################################################################ # What is different between &#39;fake treat&#39; and &#39;fake control&#39;? # Expect the 20 genes that we altered, but little else #------------------------------------------------------------------------------- # Find all markers hcabm40k.mini.c0 &lt;- hcabm40k.mini[, hcabm40k.mini$seurat_clusters == 0] # Change Ident to condition Idents(hcabm40k.mini.c0) Idents(hcabm40k.mini.c0) &lt;- hcabm40k.mini.c0$condition # default, wilcox test de_result_wilcox &lt;- FindMarkers(hcabm40k.mini.c0, ident.1 = &#39;fake_treat&#39;, ident.2 = &#39;fake_control&#39;, logfc.threshold = 0, # Give me ALL results min.pct = 0 ) # the &#39;DE&#39; genes de_result_wilcox$was_altered &lt;- rownames(de_result_wilcox ) %in% alter_genes filter(de_result_wilcox, p_val_adj &lt; 0.01) #&gt; filter(de_result_wilcox, p_val_adj &lt; 0.01) #p_val avg_log2FC pct.1 pct.2 p_val_adj #JUN 5.200733e-34 -0.75819184 0.593 0.779 5.138324e-31 #RPS8 2.630468e-08 -0.15303403 0.996 0.996 2.598902e-05 #RPS27 1.982738e-07 -0.09901833 0.999 0.999 1.958945e-04 #YBX1 3.822587e-07 0.27747948 0.798 0.711 3.776716e-04 #RPL11 1.287260e-06 -0.11034247 0.998 0.998 1.271813e-03 #FCGR3A 1.355810e-06 0.67263878 0.097 0.044 1.339541e-03 #SNAP47 3.074629e-06 1.06663146 0.072 0.029 3.037734e-03 #CHRM3-AS2 4.247678e-06 -0.90931480 0.042 0.091 4.196705e-03 #RPS7 8.027267e-06 -0.11818369 0.990 0.995 7.930940e-03 filter(de_result_wilcox, p_val_adj &lt; 0.01) filter(de_result_wilcox, was_altered == TRUE) #------------------------------------------------------------------------------- # Pseudobuilk # Change idents to sample fro grouping. levels(Idents(hcabm40k.mini.c0)) Idents(hcabm40k.mini.c0) &lt;- hcabm40k.mini.c0$orig.ident levels(Idents(hcabm40k.mini.c0)) pseudobulk_matrix &lt;- AggregateExpression( hcabm40k.mini.c0, slot = &#39;counts&#39;, assays=&#39;RNA&#39; )[[&#39;RNA&#39;]] # treat like a bulk DE library(limma) library(edgeR) dge &lt;- DGEList(pseudobulk_matrix) dge &lt;- calcNormFactors(dge) condition &lt;- factor(condition_lookup[colnames(pseudobulk_matrix)]) design &lt;- model.matrix(~condition) vm &lt;- voom(dge, design = design, plot = TRUE) fit &lt;- lmFit(vm, design = design) fit &lt;- eBayes(fit) de_result_pseudobulk &lt;- topTable(fit, n = Inf, adjust.method = &quot;BH&quot;) de_result_pseudobulk &lt;- arrange(de_result_pseudobulk , adj.P.Val) de_result_pseudobulk$was_altered &lt;- rownames(de_result_pseudobulk ) %in% alter_genes filter(de_result_pseudobulk, adj.P.Val &lt; 0.01) filter(de_result_pseudobulk, was_altered == TRUE) #----------------------------------------------------------- p1 &lt;- ggplot(de_result_pseudobulk, aes(x=AveExpr, y=logFC, col=adj.P.Val &lt; 0.5)) + geom_point() + geom_point(data=filter(de_result_pseudobulk, was_altered), pch=3, col=&#39;blue&#39;, size=5 ) + scale_colour_manual(values=c(&#39;TRUE&#39;=&quot;red&quot;,&#39;FALSE&#39;=&quot;black&quot;)) + theme_bw() + ggtitle(&quot;Pseudobulk&quot;) # Seurat doesn&#39;t give aveg expression by default, just grab it from the psuedobulk de_result_wilcox$AveExpr &lt;- de_result_pseudobulk[rownames(de_result_wilcox),c(&#39;AveExpr&#39;)] p2 &lt;- ggplot(de_result_wilcox, aes(x=AveExpr, y=avg_log2FC, col=p_val_adj &lt; 0.5)) + geom_point() + geom_point(data=filter(de_result_wilcox, was_altered), pch=3, col=&#39;blue&#39;, size=5 ) + scale_colour_manual(values=c(&#39;TRUE&#39;=&quot;red&quot;,&#39;FALSE&#39;=&quot;black&quot;)) + theme_bw() + ggtitle(&quot;Wilcox Test&quot;) p1 + p2 "],["finishing-up.html", "11 Finishing up", " 11 Finishing up "],["resources.html", "12 Resources", " 12 Resources Useful resources for next steps. "],["references.html", "References", " References "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
